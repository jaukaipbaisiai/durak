<!DOCTYPE html>
<html lang="lt">
<head>
  <meta charset="UTF-8">
  <title>Durniaus Patarėjas</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body { font-family: system-ui,sans-serif; margin:0; background:#f6f6f6;}
    .header { text-align:center; font-size:1.8em; margin: 10px 0 5px 0; color:#222; }
    .zone-label { font-weight:bold; margin:8px 0 4px 12px;}
    .zones { display:flex; gap:20px; justify-content:center; align-items:flex-start;}
    .zone { min-height:62px; min-width:66px; background: #fff; border-radius: 12px; border:2px solid #ccc; margin:7px 0; padding:8px 4px 8px 4px; display:flex; flex-wrap:wrap; align-items:center; transition:box-shadow 0.2s;}
    .zone.red { background: #ffeaea; border-color: #ff7575;}
    .zone.green { background: #eaffec; border-color: #49ca7d;}
    .zone.blue { background: #e7f4ff; border-color: #3cbcff;}
    .zone.brown { background: #eee7dc; border-color: #b98a63;}
    .zone.black { background: #eee; border-color: #333;}
    .zone.gone { background: #f7e5ff; border-color:#b359ff;}
    .zone.active { box-shadow:0 0 0 3px #8884;}
    .card {
      width: 48px; height: 68px; border-radius:10px; border:2px solid #aaa;
      background: white; margin:3px 2px 3px 2px; font-size:1.28em; font-weight:600;
      display:flex; align-items:center; justify-content:center; cursor:grab; position:relative; transition:box-shadow .13s;
      user-select:none;
    }
    .card[data-suit="♥"], .card[data-suit="♦"] { color: #dd2222;}
    .card[data-suit="♠"], .card[data-suit="♣"] { color: #1c1c1c;}
    .card.red { border-color: #ff7575;}
    .card.green { border-color: #49ca7d;}
    .card.blue { border-color: #3cbcff;}
    .card.brown { border-color: #b98a63;}
    .card.black { border-color: #333;}
    .card.gone { border-color: #b359ff;}
    .prob {
      position:absolute; bottom:3px; right:3px; background:rgba(255,118,90,0.90); color:white;
      font-size:0.87em; border-radius:5px; padding:0 4px; pointer-events:none;
    }
    .dragging { opacity: 0.7; border-style:dashed;}
    .statspanel { background:#fff; border:2px solid #eee; border-radius:14px; margin:12px 10px 10px 10px; padding:13px 13px 5px 13px; max-width:560px;}
    .chartbar { height:16px; border-radius:6px; margin:2px 0 3px 0; display:inline-block; background: linear-gradient(90deg, #ff9e7a 70%, #ffeaea 100%);}
    .chartlabel { font-size:0.97em; padding-left:4px;}
    .btn { border:none; border-radius:8px; background:#49ca7d; color:#fff; font-weight:600; font-size:1em; margin:4px 4px 4px 0; padding:7px 12px; cursor:pointer;}
    .btn:active { background:#39a95a;}
    .btn.red { background:#ff7575;}
    .btn.brown { background:#b98a63;}
    .btn.gone { background:#b359ff;}
    .btn.black { background:#444;}
    .zone-label {user-select:none;}
    #new-game-btn {float:right; margin-top:-8px;}
    .loading { color:#b98a63; font-size:1.2em; margin-top:10px; text-align:center;}
    @media (max-width:700px) {
      .card { width:35px; height:46px; font-size:1em;}
      .zone { min-width:45px;}
      #new-game-btn {float:none;display:block;margin:8px auto 4px auto;}
    }
  </style>
</head>
<body>
  <div class="header">
    Durakas Patarėjas
    <button class="btn black" id="new-game-btn" onclick="resetAll()">Naujas žaidimas</button>
  </div>
  <div class="helptext" style="text-align:center;font-size:1em; color:#444; margin-bottom:8px;">
    Vilkite kortas tarp zonų: <span style="color:#ff7575">Raudona</span> (likusios), <span style="color:#49ca7d">Žalia</span> (jūsų ranka), <span style="color:#b98a63">Ruda</span> (priešininko ranka), <span style="color:#e7f4ff">Mėlyna</span> (stalas), <span style="color:#333">Juoda</span> (koziris), <span style="color:#b359ff">Violetinė</span> (muštos).<br>
    Naudokite mygtukus po stalu ("Priešininkas pasiėmė", "Aš pasiėmiau", "Mušta") kovoms užbaigti.
  </div>

  <div class="zones">
    <div style="flex:1;">
      <div class="zone-label">Stalas (Mėlyna)</div>
      <div class="zone blue" id="table-zone" style="min-height:72px;"></div>
      <button class="btn brown" id="opp-takes-btn">Priešininkas pasiėmė</button>
      <button class="btn green" id="you-take-btn">Aš pasiėmiau</button>
      <button class="btn gone" id="fight-finished-btn">Mušta</button>
    </div>
    <div>
      <div class="zone-label">Muštos (Violetinė)</div>
      <div class="zone gone" id="gone-zone"></div>
    </div>
    <div>
      <div class="zone-label">Koziris</div>
      <div class="zone black" id="trump-zone"></div>
    </div>
  </div>

  <div class="zone-label">Jūsų kortos (Žalia)</div>
  <div class="zone green" id="your-zone"></div>

  <div class="zone-label">Priešininko ranka (Ruda, čia kortos žinomos 100%)</div>
  <div class="zone brown" id="opp-zone"></div>

  <div class="zone-label">Likusi kaladė (Raudona, galimos kortos, tikimybės – %)</div>
  <div class="zone red" id="deck-zone"></div>

  <div class="statspanel" id="stats"></div>

  <script>
    // --- CARD DATA ---
    const SUITS = ['♠','♥','♦','♣'];
    const RANKS = [9,10,11,12,13,14];
    const RANK_LABELS = {9:'9',10:'10',11:'J',12:'Q',13:'K',14:'A'};
    function cardToString(card) { return RANK_LABELS[card.rank]+card.suit; }
    function stringToCard(s) {
      let match = s.match(/^(\d+|J|Q|K|A)([♠♥♦♣])$/);
      let r = match[1], suit = match[2];
      let rank = (r==='J')?11 : (r==='Q')?12 : (r==='K')?13 : (r==='A')?14 : Number(r);
      return {rank,suit};
    }
    const ALL_CARDS = [];
    for(let suit of SUITS) for(let rank of RANKS) ALL_CARDS.push({rank,suit});

    // --- STATE ---
    let zones, dragData = null;
    let isCalculating = false;
    function defaultZones() {
      return {
        deck: ALL_CARDS.map(cardToString),
        trump: [],
        your: [],
        opp: [],
        table: [],
        gone: []
      };
    }
    zones = defaultZones();

    function showCalculating(msg=true) {
      document.getElementById('stats').innerHTML = msg ? '<div class="loading">Skaičiuojama... Palaukite.</div>' : '';
    }

    // --- DRAG-N-DROP HANDLERS ---
    function renderCard(card, zone, extra={}) {
      let suit = card.slice(-1);
      let classes = `card ${zone}`;
      let inner = card;
      if(card.length>2) inner = cardToString(stringToCard(card));
      let prob = (extra.prob!==undefined)? `<span class="prob">${extra.prob}%</span>` : '';
      return `<div class="${classes}" draggable="true" data-suit="${suit}" data-card="${card}" data-zone="${zone}" id="card-${zone}-${card.replace(/[^A-Za-z0-9]/g,'')}" ondragstart="onDrag(event,'${card}','${zone}')" ontouchstart="onTouchStart(event,'${card}','${zone}')" onmousedown="onMouseDown(event,'${card}','${zone}')">${inner}${prob}</div>`;
    }
    function renderZone(zone, el, options={}) {
      let html = '';
      let list = zones[zone];
      if(zone==='deck') {
        let probs = calcProbabilities();
        let sorted = list.slice().sort((a,b)=>(probs[b]||0)-(probs[a]||0));
        html = sorted.map(card=>renderCard(card, zone, {prob:probs[card]||0})).join('');
      } else {
        html = list.map(card=>renderCard(card, zone)).join('');
      }
      el.innerHTML = html;
    }
    function safeRender() {
      if (isCalculating) return;
      try {
        renderZone('trump',document.getElementById('trump-zone'));
        renderZone('your',document.getElementById('your-zone'));
        renderZone('opp',document.getElementById('opp-zone'));
        renderZone('table',document.getElementById('table-zone'));
        renderZone('deck',document.getElementById('deck-zone'));
        renderZone('gone',document.getElementById('gone-zone'));
        renderStats();
        setupZoneDnD();
      } catch(e) {
        document.getElementById('stats').innerHTML = "<b>Klaida!</b> Bandykite „Naujas žaidimas“.<br>"+e;
      }
    }
    let renderTimeout;
    function render() {
      // Debounce (crash-proof on very fast action)
      if (isCalculating) return;
      if (renderTimeout) clearTimeout(renderTimeout);
      renderTimeout = setTimeout(safeRender, 40);
    }
    // Drag+Drop Mouse/Touch events
    window.onDrag = function(e, card, fromZone) {
      dragData = {card,fromZone};
      e.dataTransfer.effectAllowed='move';
      setTimeout(()=>{ let c=document.getElementById(`card-${fromZone}-${card.replace(/[^A-Za-z0-9]/g,'')}`); if(c) c.classList.add('dragging'); },10);
    }
    function setupZoneDnD() {
      document.querySelectorAll('.zone').forEach(z=>{
        z.ondragover=e=>{e.preventDefault();z.classList.add('active');};
        z.ondragleave=e=>{z.classList.remove('active');};
        z.ondrop=e=>{
          e.preventDefault();
          z.classList.remove('active');
          if(dragData) { moveCard(dragData.card, dragData.fromZone, z.id.replace('-zone','')); dragData=null; }
          document.querySelectorAll('.card').forEach(c=>c.classList.remove('dragging'));
        };
      });
    }
    // Touch support (for mobile drag): simplified
    let touchTimer=null;
    window.onTouchStart = function(e, card, fromZone) {
      dragData={card,fromZone};
      document.body.addEventListener('touchmove',touchMove,false);
      document.body.addEventListener('touchend',touchEnd,false);
      touchTimer=setTimeout(()=>{},50);
    }
    function touchMove(e) {}
    function touchEnd(e) {
      let target = document.elementFromPoint(e.changedTouches[0].clientX, e.changedTouches[0].clientY);
      if(target) {
        let z=target.closest('.zone');
        if(z) { moveCard(dragData.card, dragData.fromZone, z.id.replace('-zone','')); }
      }
      dragData=null;
      document.body.removeEventListener('touchmove',touchMove,false);
      document.body.removeEventListener('touchend',touchEnd,false);
    }
    // Mouse click fallback for quick moves
    window.onMouseDown = function(e,card,fromZone) {
      if(e.ctrlKey||e.shiftKey) {
        let toZone=prompt("Perkelti į: deck/your/opp/table/trump/gone?",'your');
        if(['deck','your','opp','table','trump','gone'].includes(toZone)) moveCard(card,fromZone,toZone);
      }
    }
    // --- MOVE LOGIC ---
    function moveCard(card, from, to) {
      if(from===to) return;
      let idx = zones[from].indexOf(card);
      if(idx!==-1) zones[from].splice(idx,1);
      if(to==='trump') zones.trump=[card];
      else if(zones[to].indexOf(card)===-1) zones[to].push(card);
      render();
    }
    // --- PROBABILITIES, SUGGESTIONS, SIMULATIONS ---
    function unknownCards() {
      let known = [].concat(zones.your, zones.trump, zones.opp, zones.table, zones.gone);
      let knownSet = new Set(known);
      return ALL_CARDS.map(cardToString).filter(card=>!knownSet.has(card));
    }
    function oppHandSize() { return zones.opp.length + unknownOppHand(); }
    function unknownOppHand() {
      let nKnown = zones.opp.length;
      if(zones.opp.length===0 && zones.your.length>0) return 6;
      let totalKnown = zones.your.length+zones.trump.length+zones.opp.length+zones.table.length+zones.gone.length;
      let left = 24-totalKnown;
      return left;
    }
    function calcProbabilities() {
      let unknown = unknownCards();
      let k = unknownOppHand();
      let probs = {};
      for(let c of zones.opp) probs[c]=100;
      for(let c of unknown) probs[c]=0;
      if(k<=0) return probs;
      let rest = unknown.filter(c=>probs[c]!==100);
      if(rest.length>0) {
        let val = (100/rest.length).toFixed(1);
        for(let c of rest) probs[c]=val;
      }
      return probs;
    }
    function shuffle(a) { for(let i=a.length-1;i>0;i--){let j=Math.floor(Math.random()*(i+1));[a[i],a[j]]=[a[j],a[i]];} }
    function bestAttack() {
      let your = zones.your.slice();
      if(your.length===0) return null;
      let unknown = unknownCards(), k = unknownOppHand();
      let probs = {};
      for(let myCard of your) {
        let nWin=0, nTotal=0, nTrump=0;
        let samples= Math.min(400, Math.pow(unknown.length,k));
        for(let t=0;t<samples;t++) {
          let pool = unknown.slice(); shuffle(pool);
          let hand = pool.slice(0,k);
          let res = canOpponentDefend(myCard, hand.concat(zones.opp));
          if(!res.can) nWin++;
          if(res.trump) nTrump++;
          nTotal++;
        }
        probs[myCard]={forceTake:(nWin/nTotal*100).toFixed(1),forceTrump:(nTrump/nTotal*100).toFixed(1)};
      }
      let best = your[0];
      for(let card of your) {
        if(Number(probs[card].forceTake)>Number(probs[best].forceTake) ||
          (probs[card].forceTake===probs[best].forceTake && Number(probs[card].forceTrump)>Number(probs[best].forceTrump)))
            best = card;
      }
      return {card:best,all:probs};
    }
    function canOpponentDefend(attCard, oppHand) {
      let a = stringToCard(attCard);
      let trumpCard = zones.trump[0]||'9♠', trump = trumpCard.slice(-1);
      let can=false,trumpUsed=false;
      for(let card of oppHand) {
        let c = stringToCard(card);
        if(c.suit===a.suit && c.rank>a.rank) can=true;
        if(c.suit===trump && a.suit!==trump) {can=true;trumpUsed=true;}
      }
      return {can,trump:trumpUsed};
    }
    function bestDefense(attCard) {
      let your = zones.your.slice();
      let a = stringToCard(attCard);
      let trumpCard = zones.trump[0]||'9♠', trump = trumpCard.slice(-1);
      let candidates = [];
      for(let cstr of your) {
        let c = stringToCard(cstr);
        if(c.suit===a.suit && c.rank>a.rank) candidates.push(cstr);
        if(c.suit===trump && a.suit!==trump) candidates.push(cstr);
      }
      if(candidates.length===0) return null;
      candidates.sort((a,b)=>{
        let ca=stringToCard(a), cb=stringToCard(b);
        if(ca.suit!==cb.suit) return ca.suit<cb.suit?-1:1;
        return ca.rank-cb.rank;
      });
      return candidates[0];
    }
    function winProbability() {
      let wins=0, runs=0;
      let unknown = unknownCards(), k = unknownOppHand();
      if(zones.your.length===0) return 0;
      for(let t=0;t<25;t++) {
        let pool = unknown.slice(); shuffle(pool);
        let opp = pool.slice(0,k).concat(zones.opp), you = zones.your.slice(), deck = pool.slice(k);
        let trumpCard = zones.trump[0]||'9♠', trump = trumpCard.slice(-1);
        let res = simulateGreedy(you, opp, deck, trump);
        if(res==='win') wins++;
        runs++;
      }
      return (wins/runs*100).toFixed(1);
    }
    function simulateGreedy(you, opp, deck, trump) {
      you=you.slice(); opp=opp.slice();
      let yourTurn=true;
      while(you.length && opp.length) {
        if(yourTurn) {
          let attack = you.slice().sort((a,b)=>{
            let ca=stringToCard(a),cb=stringToCard(b);
            if(ca.suit!==cb.suit) return ca.suit<cb.suit?-1:1; return ca.rank-cb.rank; })[0];
          you.splice(you.indexOf(attack),1);
          let canDef=false;
          for(let c of opp) {
            let cc=stringToCard(c), ac=stringToCard(attack);
            if(cc.suit===ac.suit&&cc.rank>ac.rank) {canDef=true; opp.splice(opp.indexOf(c),1); break;}
            if(cc.suit===trump&&ac.suit!==trump) {canDef=true; opp.splice(opp.indexOf(c),1); break;}
          }
          if(!canDef) opp.push(attack);
        } else {
          let attack = opp.slice().sort((a,b)=>{
            let ca=stringToCard(a),cb=stringToCard(b);
            if(ca.suit!==cb.suit) return ca.suit<cb.suit?-1:1; return ca.rank-cb.rank; })[0];
          opp.splice(opp.indexOf(attack),1);
          let canDef=false;
          for(let c of you) {
            let cc=stringToCard(c), ac=stringToCard(attack);
            if(cc.suit===ac.suit&&cc.rank>ac.rank) {canDef=true; you.splice(you.indexOf(c),1); break;}
            if(cc.suit===trump&&ac.suit!==trump) {canDef=true; you.splice(you.indexOf(c),1); break;}
          }
          if(!canDef) you.push(attack);
        }
        yourTurn=!yourTurn;
      }
      if(you.length===0) return 'win';
      if(opp.length===0) return 'lose';
      return 'draw';
    }
    // --- STATS + CHART ---
    async function renderStats() {
      isCalculating = true;
      showCalculating();
      await new Promise(r=>setTimeout(r,30)); // Let UI update for fast actions!
      try {
        let statsDiv = document.getElementById('stats');
        let probs = calcProbabilities();
        let cards = unknownCards();
        let ranked = cards.slice().sort((a,b)=>(probs[b]||0)-(probs[a]||0));
        let bestA = bestAttack();
        let defCard = zones.table[0];
        let bestD = defCard?bestDefense(defCard):null;
        let winp = winProbability();
        let chartBars = ranked.slice(0,12).map(c=>{
          let w = Math.max(3, Math.round((probs[c]||0)*2.3));
          let cc = stringToCard(c);
          let col = (cc.suit==='♥'||cc.suit==='♦')?'#ff8f88':'#444';
          return `<div class="chartbar" style="width:${w}px;background:${col};"></div> <span class="chartlabel" style="color:${col}">${cardToString(cc)} (${probs[c]}%)</span>`;
        }).join('<br>');
        statsDiv.innerHTML = `
          <div style="font-size:1.1em;"><b>Statistika ir Patarimai</b></div>
          <ul>
            <li>Priešininko tikėtinos kortos:<br>
              <span>${ranked.slice(0,7).map(c=>`${cardToString(stringToCard(c))} (${probs[c]}%)`).join(', ')}</span>
              <div style="margin-top:7px;">${chartBars}</div>
            </li>
            <li>Geriausia ataka: ${
              bestA? `${cardToString(stringToCard(bestA.card))} (priverčia pasiimti: ${bestA.all[bestA.card].forceTake}%, priverčia mušti kozirį: ${bestA.all[bestA.card].forceTrump}%)`:'N/A'
            }</li>
            <li>Geriausia gynyba: ${
              defCard? (bestD? `${cardToString(stringToCard(bestD))}` : 'Imti') : 'N/A'
            }</li>
            <li>Laimėjimo tikimybė (simuliacija): <b>${winp}%</b></li>
          </ul>
        `;
      } catch(e) {
        document.getElementById('stats').innerHTML = "<b>Klaida!</b> Statistika nepavyko.";
      }
      isCalculating = false;
    }
    // --- FIGHT RESOLUTION BUTTONS ---
    document.getElementById('opp-takes-btn').onclick = function() {
      try {
        zones.opp.push(...zones.table);
        zones.table = [];
        render();
      } catch(e){render();}
    };
    document.getElementById('you-take-btn').onclick = function() {
      try {
        zones.your.push(...zones.table);
        zones.table = [];
        render();
      } catch(e){render();}
    };
    document.getElementById('fight-finished-btn').onclick = function() {
      try {
        zones.gone.push(...zones.table);
        zones.table = [];
        render();
      } catch(e){render();}
    };
    window.resetAll = function() {
      zones = defaultZones();
      render();
    };
    // --- INIT ---
    render();
  </script>
</body>
</html>
